<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat √âph√©m√®re Crypt√© ‚Äî Ultimate Responsive</title>
  <!-- PeerJS & CryptoJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    /* =================== CSS VARIABLES (Th√®mes) =================== */
    :root {
      --bg: linear-gradient(135deg, #0a2540, #16385f);
      --text: #a5d8ff;
      --muted: #80ffba;
      --card: #1e3a5f;
      --panel: #0a2540;
      --border: #4fc3f7;
      --accent: #4fc3f7;
      --accent-2: #80d8ff;
      --msg-sent: #4fc3f7;
      --msg-recv: #e0f7fa;
      --msg-text: #0a2540;
      --danger: #ff6b6b;
    }
    
    :root.light {
      --bg: linear-gradient(135deg, #f7f7f9, #eceff4);
      --text: #1f2937;
      --muted: #12805a;
      --card: #ffffff;
      --panel: #f3f4f6;
      --border: #cbd5e1;
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --msg-sent: #0ea5e9;
      --msg-recv: #e5f6ff;
      --msg-text: #0f172a;
      --danger: #ef4444;
    }

    /* =================== BASE =================== */
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Fira Code", monospace;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    /* App full-bleed container */
    .app {
      width: 100%;
      max-width: 1400px;
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: 100vh; /* plein √©cran */
      gap: 0;
      box-sizing: border-box;
    }

    /* =================== SIDEBAR (PC) / TOPBAR (Mobile) =================== */
    .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }
    .brand {
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%; background: #bbb;
    }
    .dot.online { background: #22c55e; }
    .dot.offline { background: #ef4444; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .label { font-size: 12px; opacity: 0.85; }
    .input, select {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    .row {
      display: flex; gap: 8px; align-items: center;
    }
    .btn {
      border: none; cursor: pointer; font-weight: 700;
      background: var(--accent); color: var(--msg-text);
      border-radius: 10px; padding: 10px 12px;
      transition: transform .15s ease, background .2s ease;
    }
    .btn:hover { transform: scale(1.04); background: var(--accent-2); }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.danger { background: var(--danger); color: #fff; }

    .spacer { height: 8px; }
    .divider { height: 1px; background: var(--border); opacity: .6; margin: 8px 0; border-radius: 1px; }

    /* =================== MAIN CHAT =================== */
    .main {
      display: grid;
      grid-template-rows: auto 1fr auto; /* topbar, messages, inputbar */
      height: 100vh;
      background: transparent;
    }

    .topbar {
      display: none; /* visible sur mobile */
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      align-items: center;
      gap: 8px;
    }

    .messages {
      background: var(--panel);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      display: flex; flex-direction: column; gap: 10px;
    }

    .msg {
      max-width: 65ch;
      padding: 10px 14px; border-radius: 16px;
      line-height: 1.45; position: relative; word-wrap: break-word;
      animation: pop .2s ease;
    }
    .msg.sent {
      align-self: flex-end;
      background: var(--msg-sent); color: var(--msg-text);
      border-bottom-right-radius: 6px;
    }
    .msg.recv {
      align-self: flex-start;
      background: var(--msg-recv); color: var(--msg-text);
      border-bottom-left-radius: 6px;
    }
    .msg .meta {
      font-size: 11px; opacity: .7; margin-top: 6px;
    }
    .msg .del {
      position: absolute; top: 6px; right: 8px; cursor: pointer; font-size: 12px; opacity: .7;
    }

    .typing { height: 20px; font-size: 13px; color: var(--muted); padding: 4px 12px; }

    .inputbar {
      background: var(--card);
      border-top: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 8px; padding: 10px;
      align-items: center;
    }

    .file { display: none; }

    /* =================== Animations =================== */
    @keyframes pop { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }

    /* =================== Responsive =================== */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      .sidebar {
        grid-row: 1; grid-column: 1 / -1;
        border-right: none; border-bottom: 1px solid var(--border);
        /* transforme la sidebar en top-toolbar compacte */
        flex-direction: column;
        gap: 10px;
      }
      .main { grid-row: 2; }
      .topbar { display: none; }
      .messages { border-left: none; border-right: none; }
      .inputbar { grid-template-columns: 1fr auto auto auto; }
    }

    @media (max-width: 520px) {
      .sidebar { gap: 8px; padding: 12px; }
      .row.stack { flex-direction: column; align-items: stretch; }
      .inputbar { grid-template-columns: 1fr auto auto; }
      .btn.hide-sm { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (PC) / Toolbar (Mobile) -->
    <aside class="sidebar">
      <div class="brand">‚ö° Secure P2P Chat</div>
      <div class="status-row">
        <span class="dot offline" id="status-dot"></span>
        <span id="status-text">Hors ligne</span>
      </div>

      <div class="field">
        <div class="label">Votre ID</div>
        <div class="row">
          <input id="my-id" class="input" type="text" readonly value="..." style="flex:1"/>
          <button id="copy-id" class="btn" title="Copier l'ID">üìã</button>
        </div>
      </div>

      <div class="field">
        <div class="label">Votre pseudo</div>
        <input id="pseudo" class="input" type="text" placeholder="Anonyme" />
      </div>

      <div class="field">
        <div class="label">Passphrase (cl√© partag√©e)</div>
        <input id="passphrase" class="input" type="password" placeholder="Saisir la m√™me cl√© que votre contact" />
      </div>

      <div class="field">
        <div class="label">ID du destinataire</div>
        <div class="row stack">
          <input id="peer-id" class="input" type="text" placeholder="Ex: pe-xxxxx" />
          <div class="row">
            <button id="connect" class="btn">Se connecter</button>
            <button id="disconnect" class="btn ghost">Couper</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="gap:8px; flex-wrap: wrap;">
        <button id="toggle-theme" class="btn">üåô/‚òÄÔ∏è Th√®me</button>
        <button id="clear-chat" class="btn ghost">üßπ Effacer</button>
      </div>

      <div class="field">
        <div class="label">Dur√©e des messages</div>
        <select id="expiry" class="input">
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="20000" selected>20s</option>
          <option value="60000">1 min</option>
          <option value="300000">5 min</option>
        </select>
      </div>

      <div class="spacer"></div>
      <small style="opacity:.75">P2P via PeerJS ‚Ä¢ AES via CryptoJS ‚Ä¢ Rien n'est stock√©.</small>
    </aside>

    <!-- Main chat area -->
    <main class="main">
      <div class="topbar">
        <strong>Chat</strong>
      </div>

      <section id="messages" class="messages"></section>
      <div id="typing" class="typing"></div>

      <div class="inputbar">
        <input id="message" class="input" type="text" placeholder="√âcrire un message..." />
        <input id="file" class="file" type="file" />
        <button id="file-btn" class="btn" title="Envoyer une image/un fichier">üìé</button>
        <button id="send" class="btn">Envoyer ‚û§</button>
      </div>
    </main>
  </div>

  <!-- Audio notification -->
  <audio id="notif" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    /* =============== State =============== */
    const state = {
      peer: null,
      conn: null,
      myIdEl: document.getElementById('my-id'),
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      pseudoEl: document.getElementById('pseudo'),
      passEl: document.getElementById('passphrase'),
      peerIdEl: document.getElementById('peer-id'),
      expiryEl: document.getElementById('expiry'),
      msgEl: document.getElementById('message'),
      messagesEl: document.getElementById('messages'),
      typingEl: document.getElementById('typing'),
      fileEl: document.getElementById('file'),
      lastSentAt: 0,
      antiFloodMs: 400,
    };

    /* =============== Theme handling =============== */
    const root = document.documentElement;
    function applyTheme(theme) {
      if (theme === 'light') { root.classList.add('light'); }
      else { root.classList.remove('light'); }
      localStorage.setItem('theme', theme);
    }
    // Auto from system, then user override
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) applyTheme(savedTheme);
    else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) applyTheme('light');

    document.getElementById('toggle-theme').addEventListener('click', () => {
      const current = root.classList.contains('light') ? 'light' : 'dark';
      applyTheme(current === 'light' ? 'dark' : 'light');
    });

    /* =============== Utilities =============== */
    function colorFromPseudo(pseudo) {
      let hash = 0; for (let i=0;i<pseudo.length;i++) hash = pseudo.charCodeAt(i) + ((hash<<5) - hash);
      const c = n => (n & 0xFF).toString(16).padStart(2,'0');
      return `#${c(hash>>24)}${c(hash>>16)}${c(hash>>8)}`;
    }
    function setOnline(on) {
      state.statusDot.classList.toggle('online', !!on);
      state.statusDot.classList.toggle('offline', !on);
      state.statusText.textContent = on ? 'En ligne' : 'Hors ligne';
    }
    function notify() {
      document.getElementById('notif').play().catch(()=>{});
      if (document.hidden && 'Notification' in window) {
        Notification.requestPermission().then(p => {
          if (p === 'granted') new Notification('Nouveau message');
        });
      }
    }
    function now() { return Date.now(); }

    function encrypt(obj) {
      const pass = state.passEl.value || 'my-secret-key-123'; // fallback si vide
      return CryptoJS.AES.encrypt(JSON.stringify(obj), pass).toString();
    }
    function decrypt(cipher) {
      const pass = state.passEl.value || 'my-secret-key-123';
      try {
        const txt = CryptoJS.AES.decrypt(cipher, pass).toString(CryptoJS.enc.Utf8);
        return JSON.parse(txt);
      } catch (e) { return null; }
    }

    function addMessage({type, pseudo, message, data, name}, who) {
      const box = document.createElement('div');
      box.className = 'msg ' + (who === 'me' ? 'sent' : 'recv');
      const color = colorFromPseudo(pseudo || 'Anonyme');

      let inner = `<strong style="color:${color}">${pseudo || 'Anonyme'}</strong><br/>`;
      if (type === 'text') inner += `${escapeHtml(message)}`;
      if (type === 'image') inner += `<img src="${data}" alt="image" style="max-width: min(360px, 80vw); border-radius: 10px; display:block;"/>`;
      if (type === 'file') inner += `üìé <a href="${data}" download="${name}">T√©l√©charger ${escapeHtml(name||'fichier')}</a>`;

      inner += `<span class="del" title="Supprimer">‚úñ</span>`;
      box.innerHTML = inner;
      box.querySelector('.del').addEventListener('click', () => box.remove());

      state.messagesEl.appendChild(box);
      state.messagesEl.scrollTop = state.messagesEl.scrollHeight;

      // Auto-destruction
      const ttl = parseInt(state.expiryEl.value, 10) || 20000;
      setTimeout(() => box.remove(), ttl);
    }

    function escapeHtml(str='') {
      return str.replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    /* =============== PeerJS setup =============== */
    state.peer = new Peer();

    state.peer.on('open', id => {
      state.myIdEl.value = id;
    });

    state.peer.on('connection', connection => {
      if (state.conn) state.conn.close();
      state.conn = connection;
      bindConn();
    });

    function bindConn() {
      setOnline(true);
      state.conn.on('data', raw => {
        const data = decrypt(raw);
        if (!data) return; // mauvaise cl√© ou message corrompu
        if (data.typing) {
          state.typingEl.textContent = `${data.pseudo || 'Contact'} est en train d'√©crire...`;
          clearTimeout(window.__typingTO);
          window.__typingTO = setTimeout(()=>state.typingEl.textContent='', 1200);
          return;
        }
        addMessage(data, 'peer');
        notify();
      });
      state.conn.on('close', () => { setOnline(false); });
      state.conn.on('error', () => { setOnline(false); });
    }

    /* =============== Controls =============== */
    document.getElementById('copy-id').addEventListener('click', () => {
      navigator.clipboard.writeText(state.myIdEl.value || '').then(()=>{
        state.statusText.textContent = 'ID copi√©';
        setTimeout(()=>state.statusText.textContent = state.conn? 'En ligne':'Hors ligne', 1200);
      });
    });

    document.getElementById('connect').addEventListener('click', () => {
      const target = state.peerIdEl.value.trim();
      if (!target) { state.statusText.textContent = 'Entrez un ID de destinataire'; return; }
      if (target === state.myIdEl.value) { state.statusText.textContent = 'Impossible de se connecter √† soi-m√™me'; return; }
      const c = state.peer.connect(target);
      state.conn = c;
      bindConn();
    });

    document.getElementById('disconnect').addEventListener('click', () => {
      if (state.conn) { try { state.conn.close(); } catch (e) {} }
      setOnline(false);
    });

    document.getElementById('clear-chat').addEventListener('click', () => {
      state.messagesEl.innerHTML = '';
    });

    // Send text
    document.getElementById('send').addEventListener('click', sendText);
    state.msgEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendText(); else sendTyping();
    });

    function sendText() {
      if (!state.conn) return;
      const t = now();
      if (t - state.lastSentAt < state.antiFloodMs) return; // anti-flood
      state.lastSentAt = t;

      const txt = state.msgEl.value.trim();
      if (!txt) return;
      const payload = { type: 'text', message: txt, pseudo: (state.pseudoEl.value || 'Anonyme') };
      state.conn.send(encrypt(payload));
      addMessage(payload, 'me');
      state.msgEl.value = '';
    }

    function sendTyping() {
      if (!state.conn) return;
      const payload = { typing: true, pseudo: (state.pseudoEl.value || 'Anonyme') };
      state.conn.send(encrypt(payload));
    }

    // Files/images
    document.getElementById('file-btn').addEventListener('click', () => state.fileEl.click());
    state.fileEl.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f || !state.conn) return;
      const reader = new FileReader();
      reader.onload = () => {
        const isImg = (f.type || '').startsWith('image/');
        const payload = {
          type: isImg ? 'image' : 'file',
          name: f.name,
          data: reader.result,
          pseudo: (state.pseudoEl.value || 'Anonyme'),
        };
        state.conn.send(encrypt(payload));
        addMessage(payload, 'me');
        state.fileEl.value = '';
      };
      reader.readAsDataURL(f);
    });
  </script>
</body>
</html>

